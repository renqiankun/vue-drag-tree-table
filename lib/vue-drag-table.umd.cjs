(function(n,y){typeof exports=="object"&&typeof module<"u"?module.exports=y(require("vue")):typeof define=="function"&&define.amd?define(["vue"],y):(n=typeof globalThis<"u"?globalThis:n||self,n["vue-drag-table"]=y(n.Vue))})(this,function(n){"use strict";const y="",k=(t,l)=>{const e=t.__vccOpts||t;for(const[r,c]of l)e[r]=c;return e},B={name:"column",props:{width:Number,field:String,label:String,flex:Number,border:String},data(){return{open:!1}},mounted(){}},S=["isflex"];function D(t,l,e,r,c,o){return e.flex?(n.openBlock(),n.createElementBlock("div",{key:0,class:n.normalizeClass(["tree-column",{border:e.border!==void 0}]),isflex:!!e.flex,style:n.normalizeStyle({width:e.width+"px","min-width":e.width+"px",flex:e.flex})},[n.renderSlot(t.$slots,"default")],14,S)):(n.openBlock(),n.createElementBlock("div",{key:1,class:n.normalizeClass(["tree-column",{border:e.border!==void 0}]),style:n.normalizeStyle({width:e.width+"px"})},[n.renderSlot(t.$slots,"default")],6))}const C=k(B,[["render",D]]),$="",I={name:"space",props:["depth"],computed:{spaces(){const t=[];for(let l=0;l<this.depth;l++)t.push("");return t}}},E={class:"space-container"};function T(t,l,e,r,c,o){return n.openBlock(),n.createElementBlock("span",E,[(n.openBlock(!0),n.createElementBlock(n.Fragment,null,n.renderList(o.spaces,(s,i)=>(n.openBlock(),n.createElementBlock("span",{class:"space",key:i}))),128))])}const A=k(I,[["render",T]]),ee="",L={name:"row",props:["model","depth","columns","isdraggable","border","custom_field","onCheck","isContainChildren","expandRowKeys"],inject:["expandChange"],data(){return{open:!1,visibility:"visible"}},components:{column:C,space:A},computed:{isFolder(){return this.model[this.custom_field.lists]&&this.model[this.custom_field.lists].length},currentIsOpen(){var t,l;return(l=(t=this.expandRowKeys)==null?void 0:t.some)==null?void 0:l.call(t,e=>e===this.model[this.custom_field.id])}},methods:{toggle(){this.isFolder&&(this.expandChange(this.model,!this.currentIsOpen),this.$forceUpdate())},dragstart(t){navigator.userAgent.indexOf("Firefox")>=0&&t.dataTransfer.setData("Text",this.id),window.dragId=t.target.children[0].getAttribute("tree-id"),window.dragPId=t.target.children[0].getAttribute("tree-p-id"),window.dragParentNode=t.target,t.target.style.opacity=.2},dragend(t){t.target.style.opacity=1},setAllCheckData(t,l){const e=this.custom_field.lists;for(let c=0;c<t.length;c++){var r=t[c];this.$set(r,"checked",l),r[e]&&r[e].length&&this.setAllCheckData(r[e],l)}},onCheckboxClick(t,l){l[this.custom_field.lists]&&this.isContainChildren?this.setAllCheckData([l],!!t.target.checked):this.$set(l,"checked",!!t.target.checked),this.onCheck&&this.onCheck()}}},K=["draggable"],H=["data-level","tree-id","tree-p-id"],N={key:0},z={key:1,class:"zip-icon arrow-transparent"},O=["innerHTML"],R=["innerHTML"],V={key:1},X=["name"],q={key:2},F=n.createStaticVNode('<div class="hover-model" style="display:none;"><div class="hover-block prev-block"><i class="el-icon-caret-top"></i></div><div class="hover-block center-block"><i class="el-icon-caret-right"></i></div><div class="hover-block next-block"><i class="el-icon-caret-bottom"></i></div></div>',1);function W(t,l,e,r,c,o){const s=n.resolveComponent("space"),i=n.resolveComponent("column"),d=n.resolveComponent("row",!0);return n.openBlock(),n.createElementBlock("div",{class:"tree-block",draggable:!!e.isdraggable,onDragstart:l[3]||(l[3]=a=>o.dragstart(a)),onDragend:l[4]||(l[4]=a=>o.dragend(a))},[n.createElementVNode("div",{class:n.normalizeClass(["tree-row",{"highlight-row":e.model.highlight==!0}]),"data-level":e.depth,"tree-id":e.model[e.custom_field.id],"tree-p-id":e.model[e.custom_field.parent_id],style:n.normalizeStyle({backgroundColor:e.model.backgroundColor})},[(n.openBlock(!0),n.createElementBlock(n.Fragment,null,n.renderList(e.columns,(a,f)=>(n.openBlock(),n.createBlock(i,{class:n.normalizeClass(["align-"+a.align,"colIndex"+f]),field:a.field,width:a.width,flex:a.flex,border:e.border,key:f},{default:n.withCtx(()=>[a.type==="selection"?(n.openBlock(),n.createElementBlock("span",N,[n.createVNode(s,{depth:e.depth},null,8,["depth"]),e.model[e.custom_field.lists]&&e.model[e.custom_field.lists].length?(n.openBlock(),n.createElementBlock("span",{key:0,onClick:l[0]||(l[0]=(...h)=>o.toggle&&o.toggle(...h)),class:n.normalizeClass(["zip-icon",[o.currentIsOpen?"arrow-bottom":"arrow-right"]])},null,2)):(n.openBlock(),n.createElementBlock("span",z)),a.formatter?(n.openBlock(),n.createElementBlock("span",{key:2,innerHTML:a.formatter(e.model)},null,8,O)):a.field?(n.openBlock(),n.createElementBlock("span",{key:3,innerHTML:e.model[a.field]},null,8,R)):n.renderSlot(t.$slots,"selection",{key:4,row:e.model})])):a.type==="checkbox"?(n.openBlock(),n.createElementBlock("span",V,[e.model.isShowCheckbox!==!1?n.withDirectives((n.openBlock(),n.createElementBlock("input",{key:0,type:"checkbox",name:e.model[e.custom_field.id],"onUpdate:modelValue":l[1]||(l[1]=h=>e.model[e.custom_field.checked]=h),class:"checkbox action-item",onClick:l[2]||(l[2]=n.withModifiers(h=>o.onCheckboxClick(h,e.model),["stop"]))},null,8,X)),[[n.vModelCheckbox,e.model[e.custom_field.checked]]]):n.createCommentVNode("",!0)])):(n.openBlock(),n.createElementBlock("span",q,[n.renderSlot(t.$slots,a.field,{row:e.model},()=>[n.createTextVNode(n.toDisplayString(e.model[a.field]),1)])]))]),_:2},1032,["class","field","width","flex","border"]))),128)),F],14,H),o.isFolder?(n.openBlock(!0),n.createElementBlock(n.Fragment,{key:0},n.renderList(e.model[e.custom_field.lists],(a,f)=>n.withDirectives((n.openBlock(),n.createBlock(d,{model:a,columns:e.columns,key:f,isdraggable:e.isdraggable,border:e.border,depth:e.depth*1+1,custom_field:e.custom_field,onCheck:e.onCheck,expandRowKeys:e.expandRowKeys,isContainChildren:e.isContainChildren},n.createSlots({selection:n.withCtx(({row:h})=>[n.renderSlot(t.$slots,"selection",{row:h})]),_:2},[n.renderList(e.columns,(h,g)=>({name:h.field,fn:n.withCtx(({row:_})=>[n.renderSlot(t.$slots,h.field,{row:_},()=>[n.createTextVNode(n.toDisplayString(_[h.field]),1)])])}))]),1032,["model","columns","isdraggable","border","depth","custom_field","onCheck","expandRowKeys","isContainChildren"])),[[n.vShow,o.currentIsOpen]])),128)):n.createCommentVNode("",!0)],40,K)}const w=k(L,[["render",W]]),m={clearHoverStatus(){var t=document.querySelectorAll(".tree-row");for(let l=0;l<t.length;l++){const e=t[l],r=e.children[e.children.length-1];r.style.display="none",r.children[0].style.opacity=.1,r.children[1].style.opacity=.1,r.children[2].style.opacity=.1}},getElementTop(t,l){let e=l.querySelector(".drag-tree-table-body").scrollTop;for(var r=t.offsetTop-e,c=t.offsetParent;c!==null;)r+=c.offsetTop,c=c.offsetParent;return r},getElementLeft(t){for(var l=t.offsetLeft,e=t.offsetParent;e!==null;)l+=e.offsetLeft,e=e.offsetParent;return l},deepClone(t){if(!t)return t;var l,e,r;l=Array.isArray(t)?[]:{};for(r in t)e=t[r],l[r]=typeof e=="object"?m.deepClone(e):e;return l},clearHoverStatus(){var t=document.querySelectorAll(".tree-row");for(let l=0;l<t.length;l++){const e=t[l],r=e.children[e.children.length-1];r.style.display="none",r.children[0].style.opacity=.1,r.children[1].style.opacity=.1,r.children[2].style.opacity=.1}}},te="";document.body.ondrop=function(t){t.preventDefault(),t.stopPropagation()};const Y={name:"dragTreeTable",components:{row:w,column:C},provide(){return{expandChange:(t,l)=>{this.$emit("expandChange",t,l)}}},computed:{bodyStyle(){return{overflow:this.fixed!==void 0&&this.fixed!==!1?"auto":"hidden"}},custom_field(){return{...this.default_custom_field,...this.default_field}}},props:{isdraggable:{type:Boolean,default:!0},data:Object,onDrag:{type:Function,default:()=>{}},fixed:String,height:String,border:String,onlySameLevelCanDrag:String,hightRowChange:String,resize:String,beforeDragOver:Function,expandRowKeys:{type:Array,default:()=>[]},default_field:{type:Object,default:()=>({})}},data(){return{dragX:0,dragY:0,dragId:"",targetId:"",whereInsert:"",isDraing:!1,onCheckChange:null,isContainChildren:!1,mouse:{status:0,startX:0,curColWidth:0,curIndex:0},default_custom_field:{id:"id",parent_id:"parent_id",order:"order",lists:"children",open:"open",checked:"checked",highlight:"highlight"}}},methods:{draging(t){t.preventDefault(),t.dataTransfer.dropEffect="move",this.isDraing=!0,!(t.pageX==this.dragX&&t.pageY==this.dragY)&&(this.dragX=t.pageX,this.dragY=t.clientY,this.filter(t.pageX,t.clientY),t.clientY<100?window.scrollTo(0,scrollY-6):t.clientY>document.body.clientHeight-160&&window.scrollTo(0,scrollY+6))},drop(t){m.clearHoverStatus(),this.resetTreeData(),this.isDraing=!1,this.targetId!==void 0&&this.hightRowChange!==void 0&&this.$nextTick(()=>{var l=document.querySelector("[tree-id='"+window.dragId+"']");l.style.backgroundColor="rgba(64,158,255,0.5)",setTimeout(()=>{l.style.backgroundColor="rgba(64,158,255,0)"},2e3)})},filter(t,l){var e=document.querySelectorAll(".tree-row");this.targetId=void 0;const r=window.dragParentNode.getBoundingClientRect(),c=r.left+window.dragParentNode.clientWidth,o=r.top+window.dragParentNode.clientHeight;if(t>=r.left&&t<=c&&l>=r.top&&l<=o)return;let s=null,i=null,d="";for(let f=0;f<e.length;f++){const h=e[f],g=h.getBoundingClientRect(),_=g.left,u=g.top,Q=h.clientWidth,j=h.clientHeight;if(t>_&&t<_+Q&&l>u&&l<u+j){const b=l-u,v=h.getAttribute("tree-p-id");if(this.onlySameLevelCanDrag!==void 0&&v!==window.dragPId)return;i=h.getAttribute("tree-id"),s=h.children[h.children.length-1];let x=h.offsetHeight;if(b/x>3/4)d="bottom";else if(b/x>1/4){if(this.onlySameLevelCanDrag!==void 0)return;d="center"}else d="top";break}}if(i===void 0){m.clearHoverStatus(),d="";return}let a=!0;if(this.beforeDragOver){const f=this.getItemById(this.data.lists,window.dragId),h=this.getItemById(this.data.lists,i);a=this.beforeDragOver(f,h,d)}a==!1||!s||(s.style.display="block",w.offsetHeight,d=="bottom"?s.children[2].style.opacity!=="0.5"&&(m.clearHoverStatus(),s.children[2].style.opacity=.5):d=="center"?s.children[1].style.opacity!=="0.5"&&(m.clearHoverStatus(),s.children[1].style.opacity=.5):s.children[0].style.opacity!=="0.5"&&(m.clearHoverStatus(),s.children[0].style.opacity=.5),this.targetId=i,this.whereInsert=d)},resetTreeData(){if(this.targetId===void 0)return;const t=this.custom_field.lists,l=this.custom_field.parent_id,e=this.custom_field.id,r=[],c=this.data.lists,o=this;let s=null,i=null;function d(f,h){for(let _=0;_<f.length;_++){const u=f[_];var g=m.deepClone(u);g[t]=[],o.targetId==u[e]?(s=o.getItemById(o.data.lists,window.dragId),i=o.getItemById(o.data.lists,o.targetId),o.whereInsert==="top"?(s[l]=u[l],h.push(s),h.push(g)):o.whereInsert==="center"?(s[l]=u[e],g[t].push(s),h.push(g)):(s[l]=u[l],h.push(g),h.push(s))):window.dragId!=u[e]&&h.push(g),u[t]&&u[t].length&&d(u[t],g[t])}}d(c,r),this.resetOrder(r);let a=o.getItemById(r,s[this.custom_field.parent_id]);this.onDrag(r,s,i,o.whereInsert,a),this.$emit("dragEnd",r,s,i,o.whereInsert,a)},resetOrder(t){const l=this.custom_field.lists;for(var e=0;e<t.length;e++)t[e][this.custom_field.order]=e,t[e][l]&&t[e][l].length&&this.resetOrder(t[e][l])},getItemById(t,l){var e=null;const r=this.custom_field.lists,c=this.custom_field.id;function o(s){for(let d=0;d<s.length;d++){var i=s[d];if(i[c]==l){e=JSON.parse(JSON.stringify(i));break}else i[r]&&i[r].length&&o(i[r])}}return o(t),e},DelById(t){const l=this.custom_field.lists,e=this.custom_field.order,r=this.custom_field.id,c=[],o=this.data.lists;function s(i,d){let a=0;for(let h=0;h<i.length;h++){const g=i[h];if(g[r]!=t){var f=m.deepClone(g);f[e]=a,f[l]=[],d.push(f),a++,g[l]&&g[l].length&&s(g[l],f[l])}}}return s(o,c),c},deepSetAttr(t,l,e,r){const c=this.custom_field.lists;for(var o=0;o<e.length;o++)r!==void 0?r.includes(e[o][this.custom_field.id])&&(e[o][this.custom_field[t]]=l):e[o][this.custom_field[t]]=l,e[o][c]&&e[o][c].length&&this.deepSetAttr(t,l,e[o][c],r)},ZipAll(t,l=!0){let e=m.deepClone(this.data.lists);this.deepSetAttr("open",!1,e),this.data.lists=e},OpenAll(t,l=!0){let e=m.deepClone(this.data.lists);this.deepSetAttr("open",!0,e),this.data.lists=e},GetLevelById(t){var l=this.$refs.table.querySelector('[tree-id="'+t+'"]'),e=l.getAttribute("data-level")*1;return e},HighlightRow(t,l=!0,e=!1){let r=m.deepClone(this.data.lists),c=[t];e==!0&&(c=c.concat(this.GetChildIds(t,!0))),this.deepSetAttr("highlight",l,r,c),this.data.lists=r},AddRow(t,l){const e=m.deepClone(this.data.lists);var r=this;function c(o){const s=r.custom_field.lists;for(var i=0;i<o.length;i++){if(o[i][r.custom_field.id]==t){var d=Object.assign({},l);d[r.custom_field.parent_id]=t,o[i][s]?(d[r.custom_field.order]=o[i][s].length,o[i][s].push(d)):(o[i][s]=[],d[r.custom_field.order]=0,o[i][s].push(d))}o[i][s]&&o[i][s].length&&c(o[i][s])}}c(e),this.data.lists=e},EditRow(t,l){const e=m.deepClone(this.data.lists);var r=this;function c(o){const s=r.custom_field.lists;for(var i=0;i<o.length;i++){if(o[i][r.custom_field.id]==t){var d=Object.assign({},o[i],l);console.log(2222,d),o[i]=d}o[i][s]&&o[i][s].length&&c(o[i][s])}}c(e),console.log(e),this.data.lists=e},GetChildIds(t,l=!0){let e=[];const r=this;function c(o,s){const i=r.custom_field.lists;for(var d=0;d<o.length;d++){let a="",f=o[d][r.custom_field.parent_id];s==f?(a=o[d][r.custom_field.id],e.push(a)):a=s,(l==!0||s==a)&&o[d][i]&&o[d][i].length&&c(o[d][i],a)}}return c(this.data.lists,t),e},onCheckAll(t,l){this.setAllCheckData(this.data.lists,!!t.target.checked);const e=this.getCheckedList(this.data.lists);l&&l(e)},onSingleCheckChange(){const t=this.getCheckedList(this.data.lists);this.onCheckChange&&this.onCheckChange(t)},setAllCheckData(t,l){const e=this.custom_field.lists;for(let c=0;c<t.length;c++){var r=t[c];this.$set(r,"checked",l),r[e]&&r[e].length&&this.setAllCheckData(r[e],l)}},getCheckedList(t){const l=this.custom_field.lists;var e=[];const r=m.deepClone(t);function c(o){for(let i=0;i<o.length;i++){var s=o[i];s.checked&&s.isShowCheckbox!=!1&&e.push(s),s[l]&&s[l].length&&c(s[l])}}return c(r),e},mousedown(t,l){const e=l.target.getBoundingClientRect().x,r=l.target.parentElement.offsetWidth;this.mouse={status:1,startX:e,curIndex:t,curColWidth:r}}},mounted(){this.data.custom_field&&(this.custom_field=Object.assign({},this.custom_field,this.data.custom_field)),setTimeout(()=>{this.data.columns.forEach(t=>{t.type=="checkbox"&&(this.onCheckChange=t.onChange,this.isContainChildren=t.isContainChildren)})},100),window.addEventListener("mouseup",t=>{if(this.mouse.status){const e=t.clientX;var l=document.querySelector(".drag-line");l.style.left="-10000px",this.mouse.status=0;const r=this.mouse.curColWidth,c=e-this.mouse.startX,o=r+c,s=document.querySelectorAll(".colIndex"+this.mouse.curIndex);for(let i=0;i<s.length;i++){const d=s[i];d.style.width=o+"px",d.getAttribute("isflex")&&(d.style.minWidth=o+"px")}this.data.columns[this.mouse.curIndex].width=o}}),window.addEventListener("mousemove",t=>{if(this.mouse.status){const e=t.clientX,r=document.querySelector(".drag-tree-table").getBoundingClientRect().left;var l=document.querySelector(".drag-line");l.style.left=e-r+"px"}})}},M={class:"drag-tree-table-header"},P=["onClick"],G=["innerHTML"],J=["onMousedown"],U=n.createElementVNode("div",{class:"drag-line"},null,-1);function Z(t,l,e,r,c,o){const s=n.resolveComponent("column"),i=n.resolveComponent("row");return n.openBlock(),n.createElementBlock("div",{class:n.normalizeClass(["drag-tree-table",{border:e.border!==void 0}]),ref:"table"},[n.createElementVNode("div",M,[(n.openBlock(!0),n.createElementBlock(n.Fragment,null,n.renderList(e.data.columns,(d,a)=>(n.openBlock(),n.createBlock(s,{width:d.width,flex:d.flex,border:e.border===void 0?e.resize:e.border,class:n.normalizeClass(["align-"+d.titleAlign,"colIndex"+a]),key:a},{default:n.withCtx(()=>[d.type=="checkbox"?(n.openBlock(),n.createElementBlock("input",{key:0,class:"checkbox",type:"checkbox",onClick:f=>o.onCheckAll(f,d.onChange)},null,8,P)):(n.openBlock(),n.createElementBlock("span",{key:1,innerHTML:d.title},null,8,G)),n.withDirectives(n.createElementVNode("div",{class:"resize-line",onMousedown:f=>o.mousedown(a,f)},null,40,J),[[n.vShow,e.resize!==void 0]])]),_:2},1032,["width","flex","border","class"]))),128))]),n.createElementVNode("div",{class:n.normalizeClass(["drag-tree-table-body",c.isDraing?"is-draging":""]),style:n.normalizeStyle(o.bodyStyle),onDragover:l[0]||(l[0]=(...d)=>o.draging&&o.draging(...d)),onDragend:l[1]||(l[1]=(...d)=>o.drop&&o.drop(...d))},[(n.openBlock(!0),n.createElementBlock(n.Fragment,null,n.renderList(e.data.lists,(d,a)=>(n.openBlock(),n.createBlock(i,{depth:"0",columns:e.data.columns,isdraggable:e.isdraggable,model:d,custom_field:o.custom_field,onCheck:o.onSingleCheckChange,border:e.border===void 0?e.resize:e.border,isContainChildren:c.isContainChildren,expandRowKeys:e.expandRowKeys,key:a},n.createSlots({selection:n.withCtx(({row:f})=>[n.renderSlot(t.$slots,"selection",{row:f})]),_:2},[n.renderList(e.data.columns,f=>({name:f.field,fn:n.withCtx(({row:h})=>[n.renderSlot(t.$slots,f.field,{row:h},()=>[n.createTextVNode(n.toDisplayString(h[f.field]),1)])])}))]),1032,["columns","isdraggable","model","custom_field","onCheck","border","isContainChildren","expandRowKeys"]))),128))],38),U],2)}const p=k(Y,[["render",Z]]);return p.install=t=>t.component(p.name,p),p});
